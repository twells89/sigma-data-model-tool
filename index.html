<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sigma Data Model Manager</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-hover: #222230;
            --border: #2a2a3a;
            --border-focus: #5865f2;
            --text-primary: #f0f0f5;
            --text-secondary: #9090a0;
            --text-muted: #606070;
            --accent: #5865f2;
            --accent-hover: #6875f3;
            --success: #43b581;
            --warning: #faa61a;
            --error: #f04747;
            --json-key: #79c0ff;
            --json-string: #a5d6ff;
            --json-number: #d2a8ff;
            --json-boolean: #ff7b72;
            --json-null: #8b949e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .app-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .logo-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 48px;
        }
        
        /* Credentials Section */
        .credentials-section {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }
        
        .section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 16px;
        }
        
        .form-group {
            margin-bottom: 14px;
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        
        input, select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            transition: all 0.15s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(88, 101, 242, 0.15);
        }
        
        input::placeholder {
            color: var(--text-muted);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            filter: brightness(1.1);
        }

        .btn-github {
            background: #238636;
            color: white;
            border: none;
        }

        .btn-github:hover {
            background: #2ea043;
        }

        .btn-github:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }
        
        /* Data Models List */
        .models-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .models-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .models-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .model-item {
            padding: 14px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 4px;
        }
        
        .model-item:hover {
            background: var(--bg-tertiary);
        }
        
        .model-item.active {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-focus);
        }
        
        .model-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .model-meta {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            gap: 12px;
        }
        
        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }
        
        .toolbar-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .toolbar-actions {
            display: flex;
            gap: 10px;
        }
        
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        .editor-tabs {
            display: flex;
            gap: 2px;
            padding: 12px 24px 0;
            background: var(--bg-secondary);
        }
        
        .editor-tab {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .editor-tab.active {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border);
        }
        
        .json-editor {
            flex: 1;
            padding: 24px;
            overflow: auto;
            background: var(--bg-primary);
        }
        
        .json-editor textarea {
            width: 100%;
            height: 100%;
            min-height: calc(100vh - 200px);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.7;
            color: var(--text-primary);
            resize: none;
            tab-size: 2;
        }
        
        .json-editor textarea:focus {
            outline: none;
            border-color: var(--border-focus);
        }
        
        /* Status Messages */
        .status-bar {
            padding: 10px 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        
        .status-indicator.connected {
            background: var(--success);
        }
        
        .status-indicator.error {
            background: var(--error);
        }
        
        .status-indicator.loading {
            background: var(--warning);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            padding: 14px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            font-size: 13px;
            animation: slideIn 0.2s ease;
            max-width: 400px;
        }
        
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--error); }
        .toast.warning { border-left: 3px solid var(--warning); }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.2s ease;
        }
        
        .modal-overlay.active .modal {
            transform: scale(1);
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        
        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }
        
        select.form-input {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239090a0' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        
        select.form-input:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        select.form-input option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--border-focus);
        }
        
        .form-input::placeholder {
            color: var(--text-muted);
        }
        
        .form-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }
        
        .table-config {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .table-config-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .table-config-title {
            font-size: 14px;
            font-weight: 600;
        }
        
        .table-config-remove {
            background: none;
            border: none;
            color: var(--error);
            font-size: 12px;
            cursor: pointer;
        }
        
        .column-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .column-tag {
            background: var(--bg-hover);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .column-tag-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            padding: 0;
        }
        
        .column-tag-remove:hover {
            color: var(--error);
        }
        
        .add-column-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .add-column-row input {
            flex: 1;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* Setup Guide Styles */
        .setup-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .setup-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .setup-section h3 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        
        .setup-section p {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .setup-section ol, .setup-section ul {
            font-size: 13px;
            color: var(--text-secondary);
            margin-left: 20px;
            line-height: 1.8;
        }
        
        .setup-section li {
            margin-bottom: 4px;
        }
        
        .setup-section code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }
        
        .setup-section a {
            color: var(--accent);
        }
        
        .setup-warning {
            background: rgba(250, 166, 26, 0.1);
            border-left: 3px solid var(--warning);
            padding: 10px 12px;
            border-radius: 4px;
            font-size: 12px !important;
        }
        
        .setup-table {
            width: 100%;
            font-size: 13px;
            margin: 10px 0;
            border-collapse: collapse;
        }
        
        .setup-table td {
            padding: 8px 12px;
            border: 1px solid var(--border);
        }
        
        .setup-table td:first-child {
            width: 180px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            background: var(--bg-tertiary);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            padding: 40px;
            text-align: center;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        
        .empty-state p {
            font-size: 14px;
            max-width: 300px;
        }
        
        /* Loading spinner */
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Tooltip */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 50%;
            font-size: 11px;
            color: var(--text-muted);
            cursor: help;
            margin-left: 8px;
        }

        .tooltip-text {
            visibility: hidden;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            width: 280px;
            font-size: 12px;
            line-height: 1.5;
            color: var(--text-secondary);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Cloud selector */
        .cloud-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 14px;
        }

        .cloud-option {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            text-align: center;
            transition: all 0.15s ease;
        }

        .cloud-option:hover {
            background: var(--bg-hover);
        }

        .cloud-option.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge.beta {
            background: rgba(250, 166, 26, 0.15);
            color: var(--warning);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">Œ£</div>
                    <span class="logo-text">Data Model Manager</span>
                </div>
                <div class="logo-subtitle">Code-based Data Models <span class="badge beta">Beta</span></div>
            </div>
            
            <div class="credentials-section">
                <div class="section-title">API Credentials</div>
                
                <div class="form-group">
                    <label>Sigma Cloud</label>
                    <div class="cloud-selector">
                        <div class="cloud-option active" data-cloud="aws" onclick="selectCloud('aws')">AWS</div>
                        <div class="cloud-option" data-cloud="azure" onclick="selectCloud('azure')">Azure</div>
                        <div class="cloud-option" data-cloud="gcp" onclick="selectCloud('gcp')">GCP</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="clientId">Client ID</label>
                    <input type="text" id="clientId" placeholder="Enter your Client ID">
                </div>
                
                <div class="form-group">
                    <label for="clientSecret">Client Secret</label>
                    <input type="password" id="clientSecret" placeholder="Enter your Client Secret">
                </div>
                
                <button class="btn btn-primary" id="connectBtn" onclick="connect()">
                    <span>Connect to Sigma</span>
                </button>
            </div>
            
            <div class="credentials-section" style="border-bottom: 1px solid var(--border);">
                <div class="section-title">GitHub Integration</div>
                
                <div class="form-group">
                    <label for="ghToken">Personal Access Token</label>
                    <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx">
                </div>
                
                <div class="form-group">
                    <label for="ghRepo">Repository</label>
                    <input type="text" id="ghRepo" placeholder="owner/repo-name">
                </div>
                
                <div class="form-group">
                    <label for="ghBranch">Branch</label>
                    <input type="text" id="ghBranch" placeholder="main" value="main">
                </div>
                
                <div class="form-group">
                    <label for="ghPath">Data Models Path</label>
                    <input type="text" id="ghPath" placeholder="data-models/" value="data-models/">
                </div>
                
                <button class="btn btn-secondary" id="ghConnectBtn" onclick="connectGitHub()" style="width: 100%;">
                    <span>Connect to GitHub</span>
                </button>
                
                <button class="btn btn-secondary" id="ghExportAllBtn" onclick="exportAllToGitHub()" style="width: 100%; margin-top: 10px;" disabled>
                    <span>Initial Export to GitHub</span>
                </button>
                
                <div style="margin-top: 16px; text-align: center; display: flex; justify-content: center; gap: 16px;">
                    <button onclick="showSetupGuide()" style="background: none; border: none; color: var(--accent); font-size: 11px; cursor: pointer; text-decoration: underline;">
                        üìñ Setup Guide
                    </button>
                    <button onclick="clearCredentials()" style="background: none; border: none; color: var(--text-muted); font-size: 11px; cursor: pointer; text-decoration: underline;">
                        Clear saved credentials
                    </button>
                </div>
            </div>
            
            <div class="models-section">
                <div class="models-header">
                    <span class="section-title" style="margin: 0;">Data Models</span>
                    <div style="display: flex; gap: 6px;">
                        <button class="btn btn-secondary" onclick="newDataModel()" style="padding: 6px 12px; font-size: 12px;" id="newModelBtn" disabled>
                            + New
                        </button>
                        <button class="btn btn-secondary" onclick="refreshModels()" style="padding: 6px 12px; font-size: 12px;" id="refreshBtn" disabled>
                            ‚Üª Refresh
                        </button>
                    </div>
                </div>
                <div class="models-list" id="modelsList">
                    <div class="empty-state" style="padding: 40px 20px;">
                        <div class="empty-state-icon">üìä</div>
                        <p>Connect to Sigma to view your data models</p>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="toolbar">
                <div style="display: flex; align-items: center;">
                    <div class="toolbar-title" id="editorTitle">No Data Model Selected</div>
                    <div class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <div class="tooltip-text">
                            <strong>Workflow:</strong><br>
                            1. Select a data model<br>
                            2. Edit the JSON<br>
                            3. Click "Commit Changes"<br>
                            4. Review & merge PR on GitHub<br>
                            5. Sigma syncs automatically<br><br>
                            <em>GitHub is the source of truth</em><br><br>
                            <strong>üíæ Credentials auto-saved</strong><br>
                            <em>to browser localStorage</em>
                        </div>
                    </div>
                </div>
                <div class="toolbar-actions">
                    <button class="btn btn-secondary" onclick="refreshFromSigma()" id="sigmaRefreshBtn" disabled title="Pull latest from Sigma (use after making changes in Sigma UI)">
                        ‚Üª Pull from Sigma
                    </button>
                    <button class="btn btn-secondary" onclick="formatJson()" id="formatBtn" disabled>
                        Format
                    </button>
                    <button class="btn btn-secondary" onclick="copyJson()" id="copyBtn" disabled>
                        Copy
                    </button>
                    <button class="btn btn-success" onclick="commitChanges()" id="commitBtn" disabled>
                        Commit Changes
                    </button>
                </div>
            </div>
            
            <div class="editor-container">
                <div class="editor-tabs">
                    <div class="editor-tab active">JSON Representation</div>
                </div>
                <div class="json-editor">
                    <textarea id="jsonEditor" placeholder="Select a data model from the sidebar to edit...

WORKFLOW:
1. Connect to Sigma (to see your data models)
2. Connect to GitHub (to save changes)
3. Select a data model from the sidebar
4. Edit the JSON here
5. Click 'Commit Changes' to create a PR
6. Review and merge on GitHub
7. Changes sync to Sigma automatically

GitHub is the source of truth - all changes go through PRs."></textarea>
                </div>
            </div>
            
            <div class="status-bar">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Not connected</span>
            </div>
        </main>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- New Data Model Modal -->
    <div class="modal-overlay" id="newModelModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Create New Data Model</div>
                <button class="modal-close" onclick="closeNewModelModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Data Model Name *</label>
                    <input type="text" class="form-input" id="newModelName" placeholder="e.g., Sales Analytics">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="newModelDescription" placeholder="Optional description">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Connection *</label>
                    <select class="form-input" id="newModelConnectionId" disabled>
                        <option value="">Loading connections...</option>
                    </select>
                    <div class="form-hint">Select the data warehouse connection for your tables</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Tables</span>
                        <button class="btn btn-secondary btn-small" onclick="addTableConfig()">+ Add Table</button>
                    </label>
                    <div id="tablesContainer"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeNewModelModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createDataModelFromWizard()">Create Data Model</button>
            </div>
        </div>
    </div>
    
    <!-- Setup Guide Modal -->
    <div class="modal-overlay" id="setupGuideModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">üìñ Setup Guide</div>
                <button class="modal-close" onclick="closeSetupGuide()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="setup-section">
                    <h3>Overview</h3>
                    <p>This tool lets you manage Sigma data models as code using GitHub for version control. Changes are made here, committed to GitHub via PR, and automatically synced to Sigma when merged.</p>
                </div>
                
                <div class="setup-section">
                    <h3>Step 1: Get Sigma API Credentials</h3>
                    <ol>
                        <li>Log in to Sigma Computing</li>
                        <li>Go to <strong>Administration</strong> ‚Üí <strong>Developer Access</strong></li>
                        <li>Click <strong>Create New</strong> under Client Credentials</li>
                        <li>Copy the <strong>Client ID</strong> and <strong>Client Secret</strong></li>
                    </ol>
                    <p class="setup-warning">‚ö†Ô∏è Save the Client Secret immediately - you cannot view it again!</p>
                </div>
                
                <div class="setup-section">
                    <h3>Step 2: Set Up GitHub Repository</h3>
                    <ol>
                        <li>Create a new private GitHub repository</li>
                        <li><strong><a href="https://github.com/twells89/sigma-data-model-tool/tree/main/repo-template" target="_blank">Download the repo template files</a></strong> and copy them to your repository</li>
                        <li>Your repo structure should look like:
                            <ul>
                                <li><code>.github/workflows/</code> - automation workflows</li>
                                <li><code>scripts/</code> - Python sync scripts</li>
                                <li><code>data-models/</code> - your JSON files</li>
                                <li><code>config.yml</code> - configuration</li>
                            </ul>
                        </li>
                        <li>Commit and push these files to your repo</li>
                    </ol>
                </div>
                
                <div class="setup-section">
                    <h3>Step 3: Configure GitHub Secrets & Variables</h3>
                    <p>Go to your repo: <strong>Settings</strong> ‚Üí <strong>Secrets and variables</strong> ‚Üí <strong>Actions</strong></p>
                    
                    <p><strong>Add Secrets:</strong></p>
                    <table class="setup-table">
                        <tr><td><code>SIGMA_CLIENT_ID</code></td><td>Your Sigma API Client ID</td></tr>
                        <tr><td><code>SIGMA_SECRET</code></td><td>Your Sigma API Client Secret</td></tr>
                    </table>
                    
                    <p><strong>Add Variables</strong> (click Variables tab):</p>
                    <table class="setup-table">
                        <tr><td><code>SIGMA_CLOUD</code></td><td><code>aws</code>, <code>azure</code>, or <code>gcp</code></td></tr>
                        <tr><td><code>SIGMA_FOLDER_ID</code></td><td>Folder ID for new data models</td></tr>
                    </table>
                </div>
                
                <div class="setup-section">
                    <h3>Step 4: Enable Workflow Permissions</h3>
                    <ol>
                        <li>Go to <strong>Settings</strong> ‚Üí <strong>Actions</strong> ‚Üí <strong>General</strong></li>
                        <li>Under Workflow permissions, select <strong>"Read and write permissions"</strong></li>
                        <li>Check <strong>"Allow GitHub Actions to create and approve pull requests"</strong></li>
                        <li>Click <strong>Save</strong></li>
                    </ol>
                </div>
                
                <div class="setup-section">
                    <h3>Step 5: Create GitHub Personal Access Token</h3>
                    <ol>
                        <li>Go to <a href="https://github.com/settings/tokens" target="_blank">github.com/settings/tokens</a></li>
                        <li>Click <strong>Generate new token (classic)</strong></li>
                        <li>Select only the <code>repo</code> scope</li>
                        <li>Click <strong>Generate token</strong></li>
                        <li>Copy the token (starts with <code>ghp_</code>)</li>
                    </ol>
                </div>
                
                <div class="setup-section">
                    <h3>Step 6: Find Your Sigma Folder ID</h3>
                    <ol>
                        <li>In Sigma, navigate to the folder where you want data models created</li>
                        <li>Look at the URL: <code>...sigmacomputing.com/.../folder/<strong>abc123xyz</strong></code></li>
                        <li>The folder ID is the last part of the URL</li>
                    </ol>
                </div>
                
                <div class="setup-section">
                    <h3>Using This Tool</h3>
                    <ol>
                        <li>Enter your Sigma credentials above and click <strong>Connect to Sigma</strong></li>
                        <li>Enter your GitHub token and repo (format: <code>owner/repo-name</code>)</li>
                        <li>Click <strong>Connect to GitHub</strong></li>
                        <li>Select a data model to edit, or click <strong>+ New</strong> to create one</li>
                        <li>Make changes and click <strong>Commit Changes</strong></li>
                        <li>Review and merge the PR on GitHub</li>
                        <li>Changes automatically sync to Sigma! ‚úÖ</li>
                    </ol>
                </div>
                
                <div class="setup-section">
                    <h3>Syncing Changes from Sigma UI</h3>
                    <p>If you edit a data model directly in Sigma's UI:</p>
                    <ol>
                        <li>Select the data model in this tool</li>
                        <li>Click <strong>‚Üª Pull from Sigma</strong></li>
                        <li>Click <strong>Commit Changes</strong> to save to GitHub</li>
                    </ol>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeSetupGuide()">Got it!</button>
            </div>
        </div>
    </div>
    
    <script>
        // State
        let state = {
            cloud: 'aws',
            baseUrl: 'https://aws-api.sigmacomputing.com',
            accessToken: null,
            tokenExpiry: null,
            dataModels: [],
            selectedModel: null,
            selectedModelMeta: null, // Stores the list metadata (includes inodeId)
            originalJson: null,
            githubSha: null, // SHA of the file in GitHub (for updates)
            isNewModel: false, // True when creating a new data model
            // GitHub
            github: {
                token: null,
                repo: null,
                branch: 'main',
                path: 'data-models/',
                connected: false
            }
        };
        
        // LocalStorage keys
        const STORAGE_KEYS = {
            sigma: 'sigma_dm_sigma_creds',
            github: 'sigma_dm_github_creds'
        };
        
        // Save credentials to localStorage
        function saveCredentials() {
            const sigmaData = {
                clientId: document.getElementById('clientId').value,
                clientSecret: document.getElementById('clientSecret').value,
                cloud: state.cloud
            };
            
            const githubData = {
                token: document.getElementById('ghToken').value,
                repo: document.getElementById('ghRepo').value,
                branch: document.getElementById('ghBranch').value,
                path: document.getElementById('ghPath').value
            };
            
            localStorage.setItem(STORAGE_KEYS.sigma, JSON.stringify(sigmaData));
            localStorage.setItem(STORAGE_KEYS.github, JSON.stringify(githubData));
        }
        
        // Load credentials from localStorage
        function loadCredentials() {
            try {
                const sigmaData = JSON.parse(localStorage.getItem(STORAGE_KEYS.sigma));
                if (sigmaData) {
                    document.getElementById('clientId').value = sigmaData.clientId || '';
                    document.getElementById('clientSecret').value = sigmaData.clientSecret || '';
                    if (sigmaData.cloud) {
                        selectCloud(sigmaData.cloud);
                    }
                }
                
                const githubData = JSON.parse(localStorage.getItem(STORAGE_KEYS.github));
                if (githubData) {
                    document.getElementById('ghToken').value = githubData.token || '';
                    document.getElementById('ghRepo').value = githubData.repo || '';
                    document.getElementById('ghBranch').value = githubData.branch || 'main';
                    document.getElementById('ghPath').value = githubData.path || 'data-models/';
                }
                
                return { sigmaData, githubData };
            } catch (e) {
                console.error('Error loading credentials:', e);
                return { sigmaData: null, githubData: null };
            }
        }
        
        // Clear saved credentials
        function clearCredentials() {
            localStorage.removeItem(STORAGE_KEYS.sigma);
            localStorage.removeItem(STORAGE_KEYS.github);
            document.getElementById('clientId').value = '';
            document.getElementById('clientSecret').value = '';
            document.getElementById('ghToken').value = '';
            document.getElementById('ghRepo').value = '';
            document.getElementById('ghBranch').value = 'main';
            document.getElementById('ghPath').value = 'data-models/';
            showToast('Saved credentials cleared', 'success');
        }
        
        // Auto-connect on page load
        async function autoConnect() {
            const { sigmaData, githubData } = loadCredentials();
            
            if (sigmaData?.clientId && sigmaData?.clientSecret) {
                showToast('Connecting to Sigma...', 'success');
                await connect();
            }
            
            if (githubData?.token && githubData?.repo) {
                showToast('Connecting to GitHub...', 'success');
                await connectGitHub();
            }
        }
        
        // Cloud URLs
        const cloudUrls = {
            aws: 'https://aws-api.sigmacomputing.com',
            azure: 'https://api.us.azure.sigmacomputing.com',
            gcp: 'https://api.sigmacomputing.com'
        };
        
        // Select cloud
        function selectCloud(cloud) {
            state.cloud = cloud;
            state.baseUrl = cloudUrls[cloud];
            
            document.querySelectorAll('.cloud-option').forEach(el => {
                el.classList.toggle('active', el.dataset.cloud === cloud);
            });
        }
        
        // Connect to GitHub
        async function connectGitHub() {
            const token = document.getElementById('ghToken').value.trim();
            const repo = document.getElementById('ghRepo').value.trim();
            const branch = document.getElementById('ghBranch').value.trim() || 'main';
            const path = document.getElementById('ghPath').value.trim() || 'data-models/';
            
            if (!token || !repo) {
                showToast('Please enter GitHub token and repository', 'error');
                return;
            }
            
            const btn = document.getElementById('ghConnectBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div><span>Connecting...</span>';
            
            try {
                // Test the connection by fetching repo info
                const response = await fetch(`https://api.github.com/repos/${repo}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to connect to repository');
                }
                
                const repoData = await response.json();
                
                state.github = {
                    token,
                    repo,
                    branch,
                    path: path.endsWith('/') ? path : path + '/',
                    connected: true
                };
                
                showToast(`Connected to ${repoData.full_name}`, 'success');
                btn.innerHTML = '<span>‚úì Connected</span>';
                btn.style.borderColor = 'var(--success)';
                btn.style.color = 'var(--success)';
                
                // Save credentials
                saveCredentials();
                
                // Enable Export All and New Model if Sigma is also connected
                if (state.accessToken) {
                    document.getElementById('ghExportAllBtn').disabled = false;
                    document.getElementById('newModelBtn').disabled = false;
                }
                
                // Enable commit button if a model is selected
                if (state.selectedModel) {
                    document.getElementById('commitBtn').disabled = false;
                }
                
            } catch (error) {
                console.error('GitHub connection error:', error);
                showToast(`GitHub error: ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = '<span>Connect to GitHub</span>';
            }
        }
        
        // Get filename for a data model
        function getModelFileName(model) {
            // Use a sanitized name or the dataModelId
            const name = model.name || model.dataModelId;
            return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '') + '.json';
        }
        
        // Load data model from GitHub (source of truth)
        async function loadFromGitHub(sigmaSpec) {
            const fileName = getModelFileName(sigmaSpec);
            const filePath = state.github.path + fileName;
            
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${state.github.repo}/contents/${filePath}?ref=${state.github.branch}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${state.github.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    const content = decodeURIComponent(escape(atob(data.content)));
                    const jsonData = JSON.parse(content);
                    
                    // Use GitHub version (source of truth)
                    document.getElementById('jsonEditor').value = JSON.stringify(jsonData, null, 2);
                    state.originalJson = JSON.stringify(jsonData, null, 2);
                    state.githubSha = data.sha;
                    
                    showToast('Loaded from GitHub', 'success');
                    updateStatus('connected', `Loaded: ${fileName}`);
                } else if (response.status === 404) {
                    // File doesn't exist in GitHub yet - use Sigma spec
                    showToast('New model - not yet in GitHub', 'warning');
                    state.githubSha = null;
                }
                
            } catch (error) {
                console.error('GitHub load error:', error);
                // Fall back to Sigma spec (already loaded)
            }
        }
        
        // Refresh from Sigma (pull latest changes from UI edits)
        async function refreshFromSigma() {
            if (!state.accessToken || !state.selectedModelMeta) {
                showToast('No data model selected or not connected to Sigma', 'error');
                return;
            }
            
            const btn = document.getElementById('sigmaRefreshBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div>';
            
            try {
                const dataModelId = state.selectedModelMeta.dataModelId;
                
                // Fetch latest spec from Sigma
                const response = await fetch(`${state.baseUrl}/v3alpha/datamodels/${dataModelId}/spec`, {
                    headers: {
                        'Authorization': `Bearer ${state.accessToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch from Sigma');
                }
                
                const spec = await response.json();
                
                // Update editor with Sigma's version
                state.selectedModel = spec;
                document.getElementById('jsonEditor').value = JSON.stringify(spec, null, 2);
                
                // Update status to show we have unsaved changes (since this is newer than GitHub)
                const sigmaVersion = spec.documentVersion || 0;
                updateStatus('connected', `Loaded from Sigma (v${sigmaVersion}) - Commit to sync to GitHub`);
                showToast('Loaded latest from Sigma. Commit to save to GitHub.', 'success');
                
            } catch (error) {
                console.error('Failed to refresh from Sigma:', error);
                showToast(`Failed to refresh from Sigma: ${error.message}`, 'error');
            }
            
            btn.disabled = false;
            btn.innerHTML = '‚Üª Pull from Sigma';
        }
        
        // Commit changes - creates a branch and PR
        async function commitChanges() {
            if (!state.github.connected) {
                showToast('Please connect to GitHub first', 'error');
                return;
            }
            
            if (!state.selectedModel) {
                showToast('No data model selected', 'error');
                return;
            }
            
            const editor = document.getElementById('jsonEditor');
            let jsonData;
            
            try {
                jsonData = JSON.parse(editor.value);
            } catch (error) {
                showToast('Invalid JSON - please fix before committing', 'error');
                return;
            }
            
            // Check if there are changes
            if (editor.value === state.originalJson) {
                showToast('No changes to commit', 'warning');
                return;
            }
            
            const modelName = jsonData.name || 'data-model';
            const isNew = state.isNewModel || !state.selectedModel?.dataModelId;
            const defaultMessage = isNew ? `Create ${modelName}` : `Update ${modelName}`;
            const commitMessage = prompt('Commit message:', defaultMessage);
            
            if (!commitMessage) return;
            
            const btn = document.getElementById('commitBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div><span>Creating PR...</span>';
            updateStatus('loading', 'Creating pull request...');
            
            try {
                const fileName = getModelFileName(jsonData);
                const filePath = state.github.path + fileName;
                const branchName = `${isNew ? 'create' : 'update'}-${fileName.replace('.json', '')}-${Date.now()}`;
                
                // 1. Get the SHA of the main branch
                const mainRef = await fetch(
                    `https://api.github.com/repos/${state.github.repo}/git/ref/heads/${state.github.branch}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${state.github.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (!mainRef.ok) throw new Error('Failed to get main branch');
                const mainRefData = await mainRef.json();
                const baseSha = mainRefData.object.sha;
                
                // 2. Create a new branch
                const createBranch = await fetch(
                    `https://api.github.com/repos/${state.github.repo}/git/refs`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.github.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ref: `refs/heads/${branchName}`,
                            sha: baseSha
                        })
                    }
                );
                
                if (!createBranch.ok) throw new Error('Failed to create branch');
                
                // 3. Get current file SHA if it exists
                let fileSha = state.githubSha;
                if (!fileSha) {
                    try {
                        const existingFile = await fetch(
                            `https://api.github.com/repos/${state.github.repo}/contents/${filePath}?ref=${state.github.branch}`,
                            {
                                headers: {
                                    'Authorization': `Bearer ${state.github.token}`,
                                    'Accept': 'application/vnd.github.v3+json'
                                }
                            }
                        );
                        if (existingFile.ok) {
                            const data = await existingFile.json();
                            fileSha = data.sha;
                        }
                    } catch (e) {}
                }
                
                // 4. Create/update the file on the new branch
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(jsonData, null, 2))));
                const fileBody = {
                    message: commitMessage,
                    content: content,
                    branch: branchName
                };
                if (fileSha) fileBody.sha = fileSha;
                
                const createFile = await fetch(
                    `https://api.github.com/repos/${state.github.repo}/contents/${filePath}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${state.github.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(fileBody)
                    }
                );
                
                if (!createFile.ok) throw new Error('Failed to commit file');
                
                // 5. Create pull request
                const prBody = isNew 
                    ? `## New Data Model: \`${fileName}\`\n\nThis PR creates a new data model from the Sigma Data Model Manager.\n\n**Model:** ${modelName}\n\nMerge this PR to create the data model in Sigma.`
                    : `## Changes to \`${fileName}\`\n\nThis PR was created from the Sigma Data Model Manager.\n\n**Model:** ${modelName}\n\nMerge this PR to sync changes to Sigma.`;
                
                const createPR = await fetch(
                    `https://api.github.com/repos/${state.github.repo}/pulls`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.github.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: commitMessage,
                            body: prBody,
                            head: branchName,
                            base: state.github.branch
                        })
                    }
                );
                
                if (!createPR.ok) throw new Error('Failed to create PR');
                const prData = await createPR.json();
                
                showToast('Pull request created!', 'success');
                updateStatus('connected', `PR #${prData.number} created`);
                
                // Clear new model flag
                state.isNewModel = false;
                
                // Open PR in new tab
                window.open(prData.html_url, '_blank');
                
            } catch (error) {
                console.error('Commit error:', error);
                showToast(`Failed: ${error.message}`, 'error');
                updateStatus('error', 'Commit failed');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Commit Changes';
            }
        }
        
        // List files in GitHub repo
        async function listGitHubFiles() {
            if (!state.github.connected) return [];
            
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${state.github.repo}/contents/${state.github.path}?ref=${state.github.branch}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${state.github.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (!response.ok) return [];
                
                const files = await response.json();
                return files.filter(f => f.name.endsWith('.json')).map(f => f.name);
                
            } catch (error) {
                console.error('Error listing GitHub files:', error);
                return [];
            }
        }
        
        // Export all data models to GitHub
        async function exportAllToGitHub() {
            if (!state.github.connected || !state.accessToken) {
                showToast('Please connect to both Sigma and GitHub first', 'error');
                return;
            }
            
            if (state.dataModels.length === 0) {
                showToast('No data models to export', 'warning');
                return;
            }
            
            const confirmExport = confirm(`Export ${state.dataModels.length} data models to GitHub?\n\nThis will create/update files in: ${state.github.path}`);
            if (!confirmExport) return;
            
            const btn = document.getElementById('ghExportAllBtn');
            btn.disabled = true;
            
            let success = 0;
            let failed = 0;
            
            for (let i = 0; i < state.dataModels.length; i++) {
                const model = state.dataModels[i];
                btn.innerHTML = `<div class="spinner"></div><span>Exporting ${i + 1}/${state.dataModels.length}...</span>`;
                updateStatus('loading', `Exporting: ${model.name || 'Untitled'}`);
                
                try {
                    // Fetch the full spec
                    const specResponse = await fetch(`${state.baseUrl}/v3alpha/datamodels/${model.dataModelId}/spec`, {
                        headers: {
                            'Authorization': `Bearer ${state.accessToken}`
                        }
                    });
                    
                    if (!specResponse.ok) {
                        throw new Error('Failed to fetch spec');
                    }
                    
                    const specData = await specResponse.json();
                    const fileName = getModelFileName(specData);
                    const filePath = state.github.path + fileName;
                    
                    // Check for existing file
                    let sha = null;
                    try {
                        const existingFile = await fetch(
                            `https://api.github.com/repos/${state.github.repo}/contents/${filePath}?ref=${state.github.branch}`,
                            {
                                headers: {
                                    'Authorization': `Bearer ${state.github.token}`,
                                    'Accept': 'application/vnd.github.v3+json'
                                }
                            }
                        );
                        if (existingFile.ok) {
                            const data = await existingFile.json();
                            sha = data.sha;
                        }
                    } catch (e) {
                        // File doesn't exist
                    }
                    
                    // Push to GitHub
                    const content = btoa(unescape(encodeURIComponent(JSON.stringify(specData, null, 2))));
                    const body = {
                        message: `Export ${specData.name || 'data model'}`,
                        content: content,
                        branch: state.github.branch
                    };
                    if (sha) body.sha = sha;
                    
                    const pushResponse = await fetch(
                        `https://api.github.com/repos/${state.github.repo}/contents/${filePath}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${state.github.token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(body)
                        }
                    );
                    
                    if (!pushResponse.ok) {
                        throw new Error('Failed to push to GitHub');
                    }
                    
                    success++;
                    
                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error(`Error exporting ${model.name}:`, error);
                    failed++;
                }
            }
            
            btn.disabled = false;
            btn.innerHTML = '<span>Initial Export to GitHub</span>';
            
            if (failed === 0) {
                showToast(`Successfully exported ${success} data models`, 'success');
            } else {
                showToast(`Exported ${success} models, ${failed} failed`, 'warning');
            }
            
            updateStatus('connected', `Export complete: ${success}/${state.dataModels.length}`);
        }
        
        // Toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.2s ease reverse';
                setTimeout(() => toast.remove(), 200);
            }, 4000);
        }
        
        // Update status
        function updateStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = 'status-indicator ' + status;
            statusText.textContent = text;
        }
        
        // Connect to Sigma
        async function connect() {
            const clientId = document.getElementById('clientId').value.trim();
            const clientSecret = document.getElementById('clientSecret').value.trim();
            
            if (!clientId || !clientSecret) {
                showToast('Please enter both Client ID and Client Secret', 'error');
                return;
            }
            
            const btn = document.getElementById('connectBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div><span>Connecting...</span>';
            updateStatus('loading', 'Authenticating...');
            
            try {
                // Get access token
                const tokenResponse = await fetch(`${state.baseUrl}/v2/auth/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        grant_type: 'client_credentials',
                        client_id: clientId,
                        client_secret: clientSecret
                    })
                });
                
                if (!tokenResponse.ok) {
                    const error = await tokenResponse.json();
                    throw new Error(error.message || 'Authentication failed');
                }
                
                const tokenData = await tokenResponse.json();
                state.accessToken = tokenData.access_token;
                state.tokenExpiry = Date.now() + (tokenData.expires_in * 1000);
                
                updateStatus('connected', 'Connected to Sigma');
                showToast('Successfully connected to Sigma!', 'success');
                
                // Save credentials
                saveCredentials();
                
                // Enable buttons
                document.getElementById('refreshBtn').disabled = false;
                
                // Load data models
                await loadDataModels();
                
            } catch (error) {
                console.error('Connection error:', error);
                updateStatus('error', 'Connection failed');
                showToast(`Connection failed: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Connect to Sigma</span>';
            }
        }
        
        // Load data models
        async function loadDataModels() {
            updateStatus('loading', 'Loading data models...');
            
            try {
                const response = await fetch(`${state.baseUrl}/v2/datamodels`, {
                    headers: {
                        'Authorization': `Bearer ${state.accessToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load data models');
                }
                
                const data = await response.json();
                state.dataModels = data.entries || [];
                
                // dataModels entries include: dataModelId, name, url, createdBy, updatedBy, createdAt, updatedAt
                // We also need inodeId for renaming - it's typically available in the response
                
                renderModelsList();
                updateStatus('connected', `Connected ‚Ä¢ ${state.dataModels.length} data models`);
                
                // Enable Export All and New Model if GitHub is also connected
                if (state.github.connected) {
                    document.getElementById('ghExportAllBtn').disabled = false;
                    document.getElementById('newModelBtn').disabled = false;
                }
                
            } catch (error) {
                console.error('Load error:', error);
                updateStatus('error', 'Failed to load data models');
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        // Refresh models
        async function refreshModels() {
            if (!state.accessToken) return;
            await loadDataModels();
            showToast('Data models refreshed', 'success');
        }
        
        // Create a new data model
        // Track wizard state
        let wizardState = {
            tables: [],
            connections: []
        };
        
        async function loadConnections() {
            const select = document.getElementById('newModelConnectionId');
            select.innerHTML = '<option value="">Loading connections...</option>';
            select.disabled = true;
            
            try {
                const response = await fetch(`${state.baseUrl}/v2/connections`, {
                    headers: {
                        'Authorization': `Bearer ${state.accessToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load connections');
                }
                
                const data = await response.json();
                wizardState.connections = data.entries || [];
                
                select.innerHTML = '<option value="">Select a connection...</option>';
                wizardState.connections.forEach(conn => {
                    const option = document.createElement('option');
                    option.value = conn.connectionId;
                    option.textContent = conn.name;
                    select.appendChild(option);
                });
                select.disabled = false;
                
            } catch (error) {
                console.error('Failed to load connections:', error);
                select.innerHTML = '<option value="">Failed to load - enter ID manually</option>';
                // Fall back to text input
                const parent = select.parentElement;
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-input';
                input.id = 'newModelConnectionId';
                input.placeholder = 'Enter connection ID manually';
                parent.replaceChild(input, select);
            }
        }
        
        function newDataModel() {
            if (!state.github.connected) {
                showToast('Please connect to GitHub first', 'error');
                return;
            }
            
            if (!state.accessToken) {
                showToast('Please connect to Sigma first', 'error');
                return;
            }
            
            // Reset wizard state
            wizardState.tables = [];
            document.getElementById('newModelName').value = '';
            document.getElementById('newModelDescription').value = '';
            document.getElementById('tablesContainer').innerHTML = '';
            
            // Reset connection dropdown
            const connSelect = document.getElementById('newModelConnectionId');
            if (connSelect.tagName === 'SELECT') {
                connSelect.innerHTML = '<option value="">Loading connections...</option>';
                connSelect.disabled = true;
            }
            
            // Add one table by default
            addTableConfig();
            
            // Show modal
            document.getElementById('newModelModal').classList.add('active');
            
            // Load connections
            loadConnections();
        }
        
        function closeNewModelModal() {
            document.getElementById('newModelModal').classList.remove('active');
        }
        
        function showSetupGuide() {
            document.getElementById('setupGuideModal').classList.add('active');
        }
        
        function closeSetupGuide() {
            document.getElementById('setupGuideModal').classList.remove('active');
        }
        
        let tableCounter = 0;
        
        function addTableConfig() {
            tableCounter++;
            const tableId = `table_${tableCounter}`;
            const container = document.getElementById('tablesContainer');
            
            const tableHtml = `
                <div class="table-config" id="${tableId}">
                    <div class="table-config-header">
                        <span class="table-config-title">Table ${tableCounter}</span>
                        <button class="table-config-remove" onclick="removeTableConfig('${tableId}')">Remove</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Table Name *</label>
                        <input type="text" class="form-input table-name" placeholder="e.g., Orders">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Source Path * (Database / Schema / Table)</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                            <input type="text" class="form-input table-database" placeholder="DATABASE">
                            <input type="text" class="form-input table-schema" placeholder="SCHEMA">
                            <input type="text" class="form-input table-source" placeholder="TABLE_NAME">
                        </div>
                        <div class="form-hint">The warehouse path to your source table</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Columns</label>
                        <div class="column-list" id="${tableId}_columns"></div>
                        <div class="add-column-row">
                            <input type="text" class="form-input" id="${tableId}_newColumn" placeholder="Column name" onkeypress="if(event.key==='Enter'){addColumn('${tableId}'); event.preventDefault();}">
                            <button class="btn btn-secondary btn-small" onclick="addColumn('${tableId}')">Add</button>
                        </div>
                        <div class="form-hint">Press Enter or click Add for each column. Leave empty to add columns manually in JSON.</div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', tableHtml);
        }
        
        function removeTableConfig(tableId) {
            const element = document.getElementById(tableId);
            if (element) {
                element.remove();
            }
        }
        
        function addColumn(tableId) {
            const input = document.getElementById(`${tableId}_newColumn`);
            const columnName = input.value.trim();
            
            if (!columnName) return;
            
            const columnList = document.getElementById(`${tableId}_columns`);
            const columnId = `${tableId}_col_${Date.now()}`;
            
            const columnHtml = `
                <span class="column-tag" id="${columnId}" data-column-name="${columnName}">
                    ${columnName}
                    <button class="column-tag-remove" onclick="removeColumn('${columnId}')">&times;</button>
                </span>
            `;
            
            columnList.insertAdjacentHTML('beforeend', columnHtml);
            input.value = '';
            input.focus();
        }
        
        function removeColumn(columnId) {
            const element = document.getElementById(columnId);
            if (element) {
                element.remove();
            }
        }
        
        function createDataModelFromWizard() {
            const modelName = document.getElementById('newModelName').value.trim();
            const description = document.getElementById('newModelDescription').value.trim();
            const connectionId = document.getElementById('newModelConnectionId').value.trim();
            
            if (!modelName) {
                showToast('Please enter a data model name', 'error');
                return;
            }
            
            if (!connectionId) {
                showToast('Please select a connection', 'error');
                return;
            }
            
            // Gather table configurations
            const tableConfigs = document.querySelectorAll('.table-config');
            const elements = [];
            
            tableConfigs.forEach((tableEl, index) => {
                const tableName = tableEl.querySelector('.table-name').value.trim();
                const database = tableEl.querySelector('.table-database').value.trim();
                const schema = tableEl.querySelector('.table-schema').value.trim();
                const sourceTable = tableEl.querySelector('.table-source').value.trim();
                
                if (!tableName || !database || !schema || !sourceTable) {
                    return; // Skip incomplete tables
                }
                
                // Get columns
                const columnTags = tableEl.querySelectorAll('.column-tag');
                const columns = [];
                
                columnTags.forEach((tag, colIndex) => {
                    const colName = tag.getAttribute('data-column-name');
                    if (colName) {
                        columns.push({
                            id: `col_${index}_${colIndex}_${Date.now()}`,
                            name: colName,
                            formula: `[${sourceTable}/${colName}]`
                        });
                    }
                });
                
                elements.push({
                    id: `element_${index}_${Date.now()}`,
                    name: tableName,
                    kind: "table",
                    source: {
                        connectionId: connectionId,
                        kind: "warehouse-table",
                        path: [database, schema, sourceTable]
                    },
                    columns: columns
                });
            });
            
            if (elements.length === 0) {
                showToast('Please configure at least one table with all required fields', 'error');
                return;
            }
            
            // Create the data model template
            const template = {
                schemaVersion: 1,
                name: modelName,
                description: description,
                pages: [
                    {
                        id: "page_" + Date.now(),
                        name: "Page 1",
                        elements: elements
                    }
                ]
            };
            
            // Set up state for the new model
            state.selectedModel = template;
            state.selectedModelMeta = null;
            state.originalJson = null;
            state.githubSha = null;
            state.isNewModel = true;
            
            // Update UI
            document.getElementById('editorTitle').textContent = modelName + ' (New)';
            document.getElementById('jsonEditor').value = JSON.stringify(template, null, 2);
            
            // Enable buttons
            document.getElementById('formatBtn').disabled = false;
            document.getElementById('copyBtn').disabled = false;
            document.getElementById('sigmaRefreshBtn').disabled = true; // Can't refresh new model from Sigma
            document.getElementById('commitBtn').disabled = false;
            
            // Clear active state from model list
            document.querySelectorAll('.model-item').forEach(el => el.classList.remove('active'));
            
            // Close modal
            closeNewModelModal();
            
            updateStatus('connected', `Creating: ${modelName}`);
            showToast(`Created data model with ${elements.length} table(s). Review the JSON and click Commit Changes.`, 'success');
        }
        
        // Render models list
        function renderModelsList() {
            const container = document.getElementById('modelsList');
            
            if (state.dataModels.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 40px 20px;">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No data models found in your organization</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = state.dataModels.map(model => `
                <div class="model-item ${state.selectedModel?.dataModelId === model.dataModelId ? 'active' : ''}" 
                     onclick="selectModel('${model.dataModelId}')">
                    <div class="model-name">${model.name || 'Untitled'}</div>
                    <div class="model-meta">
                        <span>Updated: ${formatDate(model.updatedAt)}</span>
                    </div>
                </div>
            `).join('');
        }
        
        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        }
        
        // Select a model
        async function selectModel(dataModelId) {
            updateStatus('loading', 'Loading data model...');
            
            // Clear new model flag since we're selecting an existing one
            state.isNewModel = false;
            
            // Store the model metadata from the list (may include inodeId)
            state.selectedModelMeta = state.dataModels.find(m => m.dataModelId === dataModelId);
            
            try {
                // Fetch the JSON representation using v3alpha endpoint
                const response = await fetch(`${state.baseUrl}/v3alpha/datamodels/${dataModelId}/spec`, {
                    headers: {
                        'Authorization': `Bearer ${state.accessToken}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to load data model');
                }
                
                const data = await response.json();
                state.selectedModel = data;
                state.originalJson = JSON.stringify(data, null, 2);
                
                // Update UI
                document.getElementById('jsonEditor').value = state.originalJson;
                document.getElementById('editorTitle').textContent = data.name || 'Untitled Data Model';
                
                // Enable buttons
                document.getElementById('formatBtn').disabled = false;
                document.getElementById('copyBtn').disabled = false;
                document.getElementById('sigmaRefreshBtn').disabled = false; // Can refresh from Sigma
                
                // Enable GitHub buttons if connected
                if (state.github.connected) {
                    document.getElementById('commitBtn').disabled = false;
                    
                    // Try to load from GitHub (source of truth)
                    await loadFromGitHub(data);
                }
                
                renderModelsList();
                updateStatus('connected', `Editing: ${data.name || 'Untitled'}`);
                showToast('Data model loaded successfully', 'success');
                
            } catch (error) {
                console.error('Select error:', error);
                updateStatus('error', 'Failed to load data model');
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        // Rename data model using files API
        // Format JSON
        function formatJson() {
            const editor = document.getElementById('jsonEditor');
            try {
                const parsed = JSON.parse(editor.value);
                editor.value = JSON.stringify(parsed, null, 2);
                showToast('JSON formatted', 'success');
            } catch (error) {
                showToast('Invalid JSON - cannot format', 'error');
            }
        }
        
        // Copy JSON
        function copyJson() {
            const editor = document.getElementById('jsonEditor');
            navigator.clipboard.writeText(editor.value);
            showToast('JSON copied to clipboard', 'success');
        }
        
        // Handle keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 's') {
                e.preventDefault();
                if (state.github.connected && state.selectedModel) {
                    commitChanges();
                }
            }
        });
        
        // Auto-resize textarea
        const editor = document.getElementById('jsonEditor');
        editor.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.max(this.scrollHeight, 500) + 'px';
        });
        
        // On page load, try to auto-connect with saved credentials
        window.addEventListener('DOMContentLoaded', () => {
            const { sigmaData, githubData } = loadCredentials();
            
            // Show that credentials are loaded
            if (sigmaData?.clientId || githubData?.token) {
                setTimeout(autoConnect, 500);
            }
        });
    </script>
        <script data-goatcounter="https://tjwells89.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>
